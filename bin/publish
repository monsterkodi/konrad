#!/usr/bin/env bash
TEST=`sds -rp scripts.test`
if [ -n "$TEST" ] ; then
    if ! npm test ; then
        echo '[ERROR] test failed!' | colorcat -p "(\[)(.+)(\])(.*) . Rfr . Rfy . Rfr . fy" 
        exit 1
    fi
fi

if [ $# -ne 0 ]; then
    `dirname $0`/commit "$*"
fi

`dirname $0`/bump
`dirname $0`/commit

VERSION=`sds -rp version`

echo 'tagging' | colorcat -x
git tag -f -a -m "v$VERSION" $VERSION
echo 'pushing tags' | colorcat -x
git push --tags -q
echo 'npm publish'  | colorcat -x
npm publish
if [ -e `npm -g bin`/`sds -rp name` ]; then
    echo "installing `sds -rp name` globally" | colorcat -p "(.*)( .* )(.*)  . x . fy . x"
    npm install -g `sds -rp name`
fi
