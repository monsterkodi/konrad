#!/usr/bin/env bash
TEST=`sds -rp scripts.test`
if [ -n "$TEST" ] ; then
    if ! npm test ; then
        echo -n '[ERROR] test failed!' | colorcat -Ryf
        exit 1
    fi
fi

if [ $# -ne 0 ]; then
    `dirname $0`/commit "$*"
fi

if [ "`sds -rp 'konrad.bump on'`" != "commit" ]; then
    `dirname $0`/bump
    `dirname $0`/commit
fi

VERSION=`sds -rp version`

git tag -f -a -m "v$VERSION" $VERSION
git push --tags -q
npm publish
if [ -e `npm -g bin`/`sds -rp name` ]; then
    echo -n "installing `sds -rp name` globally" | colorcat -yf
    npm install -g `sds -rp name`
fi
