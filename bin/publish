#!/usr/bin/env bash

TEST=`sds -rp scripts.test`
if [ -n "$TEST" ] ; then
    if ! npm test ; then
        echo '[ERROR] test failed!' | colorcat -sp "(\[)(.+)(\])(.*) . Rfr . Rfy . Rfr . fy" 
        exit 1
    fi
fi

if [ $# -ne 0 ]; then
    `dirname $0`/commit "$*"
fi

set -e

`dirname $0`/bump
`dirname $0`/commit

VERSION=`sds -rp version`

echo "tagging $VERSION"               | colorcat -sx
git tag -f -a -m "v$VERSION" $VERSION

echo 'pushing tag'                    | colorcat -sx
git push --tags -q

echo 'npm publish'                    | colorcat -sx
npm publish                           | colorcat -P `dirname $0`/../cc/npm.noon

if [ -e `npm -g bin`/`sds -rp name` ]; then
    echo "installing `sds -rp name` globally" | colorcat -sp "(.*)( .* )(.*)  . x . fy . x"
    npm install -g `sds -rp name`             | colorcat -sP `dirname $0`/../cc/npm.noon
fi
