#!/usr/bin/env bash
TEST=`sds -rp scripts.test`
if [ -n "$TEST" ] ; then
    if ! npm test ; then
        echo '[ERROR] test failed!' | lolcat -p 0.3
        exit 1
    fi
fi

if [ $# -eq 0 ]; then
    git push
else
    `dirname $0`/commit "$*"
fi

if [ "`sds -rp 'konrad.bump on'`" != "commit" ]; then
    `dirname $0`/bump
fi

`dirname $0`/commit

VERSION=`sds -rp version`

git tag -f -a -m "v$VERSION" $VERSION
git push --tags -q
npm publish
if [ -e `npm -g bin`/`sds -rp name` ]; then
    echo "installing `sds -rp name` globally"
    npm install -g `sds -rp name`
fi
