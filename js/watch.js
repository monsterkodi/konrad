// koffee 1.4.0

/*
000   000   0000000   000000000   0000000  000   000
000 0 000  000   000     000     000       000   000
000000000  000000000     000     000       000000000
000   000  000   000     000     000       000   000
00     00  000   000     000      0000000  000   000
 */
var Watch, _, args, build, colors, config, klog, pkg, pretty, ref, runcmd, should, slash, watcher,
    indexOf = [].indexOf;

ref = require('kxk'), colors = ref.colors, slash = ref.slash, args = ref.args, klog = ref.klog, _ = ref._;

pretty = require('./pretty');

should = require('./should');

runcmd = require('./runcmd');

config = require('./config');

build = require('./build');

pkg = require('../package.json');

watcher = null;

Watch = function(wlk, opt) {
    var start;
    start = function(cb) {
        var d, pass, ref1, v;
        pass = function(p) {
            var ref1;
            return ref1 = slash.ext(p), indexOf.call(_.keys(opt), ref1) >= 0;
        };
        d = (ref1 = args["arguments"][0]) != null ? ref1 : '.';
        v = (pkg.version + " ‚óè").dim.gray;
        klog(pretty.time(), ("üëÅ   " + v + " " + (pretty.filePath(slash.resolve(d), colors.white))).gray);
        watcher = require('kxk').watch.watch(d, {
            recursive: true,
            ignore: wlk.ignore
        });
        return watcher.on('change', function(info) {
            if (pass(info.path)) {
                return cb(slash.path(info.path));
            }
        });
    };
    return start(function(sourceFile) {
        var o, test;
        sourceFile = slash.resolve(sourceFile);
        o = config.obj(sourceFile, opt);
        test = function(source) {
            if (should('test', o, source)) {
                return runcmd('test', source, config.path('test', slash.resolve(source), opt));
            }
        };
        if (!should('ignore', o, sourceFile)) {
            return build(sourceFile, opt, test);
        } else {
            return test(sourceFile);
        }
    });
};

module.exports = Watch;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2F0Y2guanMiLCJzb3VyY2VSb290IjoiLiIsInNvdXJjZXMiOlsiIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7Ozs7QUFBQSxJQUFBLDZGQUFBO0lBQUE7O0FBUUEsTUFBbUMsT0FBQSxDQUFRLEtBQVIsQ0FBbkMsRUFBRSxtQkFBRixFQUFVLGlCQUFWLEVBQWlCLGVBQWpCLEVBQXVCLGVBQXZCLEVBQTZCOztBQUU3QixNQUFBLEdBQVMsT0FBQSxDQUFRLFVBQVI7O0FBQ1QsTUFBQSxHQUFTLE9BQUEsQ0FBUSxVQUFSOztBQUNULE1BQUEsR0FBUyxPQUFBLENBQVEsVUFBUjs7QUFDVCxNQUFBLEdBQVMsT0FBQSxDQUFRLFVBQVI7O0FBQ1QsS0FBQSxHQUFTLE9BQUEsQ0FBUSxTQUFSOztBQUNULEdBQUEsR0FBUyxPQUFBLENBQVEsaUJBQVI7O0FBRVQsT0FBQSxHQUFVOztBQUVWLEtBQUEsR0FBUSxTQUFDLEdBQUQsRUFBTSxHQUFOO0FBSUosUUFBQTtJQUFBLEtBQUEsR0FBUSxTQUFDLEVBQUQ7QUFFSixZQUFBO1FBQUEsSUFBQSxHQUFPLFNBQUMsQ0FBRDtBQUFPLGdCQUFBOzBCQUFBLEtBQUssQ0FBQyxHQUFOLENBQVUsQ0FBVixDQUFBLEVBQUEsYUFBZ0IsQ0FBQyxDQUFDLElBQUYsQ0FBTyxHQUFQLENBQWhCLEVBQUEsSUFBQTtRQUFQO1FBRVAsQ0FBQSxrREFBd0I7UUFDeEIsQ0FBQSxHQUFJLENBQUcsR0FBRyxDQUFDLE9BQUwsR0FBYSxJQUFmLENBQWtCLENBQUMsR0FBRyxDQUFDO1FBQzNCLElBQUEsQ0FBSyxNQUFNLENBQUMsSUFBUCxDQUFBLENBQUwsRUFBb0IsQ0FBQSxPQUFBLEdBQVEsQ0FBUixHQUFVLEdBQVYsR0FBWSxDQUFDLE1BQU0sQ0FBQyxRQUFQLENBQWdCLEtBQUssQ0FBQyxPQUFOLENBQWMsQ0FBZCxDQUFoQixFQUFrQyxNQUFNLENBQUMsS0FBekMsQ0FBRCxDQUFaLENBQTZELENBQUMsSUFBbEY7UUFDQSxPQUFBLEdBQVUsT0FBQSxDQUFRLEtBQVIsQ0FBYyxDQUFDLEtBQUssQ0FBQyxLQUFyQixDQUEyQixDQUEzQixFQUE4QjtZQUFBLFNBQUEsRUFBVSxJQUFWO1lBQWdCLE1BQUEsRUFBTyxHQUFHLENBQUMsTUFBM0I7U0FBOUI7ZUFDVixPQUFPLENBQUMsRUFBUixDQUFXLFFBQVgsRUFBb0IsU0FBQyxJQUFEO1lBQ2hCLElBQUcsSUFBQSxDQUFLLElBQUksQ0FBQyxJQUFWLENBQUg7dUJBQXVCLEVBQUEsQ0FBRyxLQUFLLENBQUMsSUFBTixDQUFXLElBQUksQ0FBQyxJQUFoQixDQUFILEVBQXZCOztRQURnQixDQUFwQjtJQVJJO1dBV1IsS0FBQSxDQUFNLFNBQUMsVUFBRDtBQUVGLFlBQUE7UUFBQSxVQUFBLEdBQWEsS0FBSyxDQUFDLE9BQU4sQ0FBYyxVQUFkO1FBQ2IsQ0FBQSxHQUFJLE1BQU0sQ0FBQyxHQUFQLENBQVcsVUFBWCxFQUF1QixHQUF2QjtRQUVKLElBQUEsR0FBTyxTQUFDLE1BQUQ7WUFDSCxJQUFHLE1BQUEsQ0FBTyxNQUFQLEVBQWMsQ0FBZCxFQUFpQixNQUFqQixDQUFIO3VCQUNJLE1BQUEsQ0FBTyxNQUFQLEVBQWMsTUFBZCxFQUFzQixNQUFNLENBQUMsSUFBUCxDQUFZLE1BQVosRUFBbUIsS0FBSyxDQUFDLE9BQU4sQ0FBYyxNQUFkLENBQW5CLEVBQTBDLEdBQTFDLENBQXRCLEVBREo7O1FBREc7UUFJUCxJQUFHLENBQUksTUFBQSxDQUFPLFFBQVAsRUFBZ0IsQ0FBaEIsRUFBbUIsVUFBbkIsQ0FBUDttQkFDSSxLQUFBLENBQU0sVUFBTixFQUFrQixHQUFsQixFQUF1QixJQUF2QixFQURKO1NBQUEsTUFBQTttQkFHSSxJQUFBLENBQUssVUFBTCxFQUhKOztJQVRFLENBQU47QUFmSTs7QUE2QlIsTUFBTSxDQUFDLE9BQVAsR0FBaUIiLCJzb3VyY2VzQ29udGVudCI6WyIjIyNcbjAwMCAgIDAwMCAgIDAwMDAwMDAgICAwMDAwMDAwMDAgICAwMDAwMDAwICAwMDAgICAwMDBcbjAwMCAwIDAwMCAgMDAwICAgMDAwICAgICAwMDAgICAgIDAwMCAgICAgICAwMDAgICAwMDBcbjAwMDAwMDAwMCAgMDAwMDAwMDAwICAgICAwMDAgICAgIDAwMCAgICAgICAwMDAwMDAwMDBcbjAwMCAgIDAwMCAgMDAwICAgMDAwICAgICAwMDAgICAgIDAwMCAgICAgICAwMDAgICAwMDBcbjAwICAgICAwMCAgMDAwICAgMDAwICAgICAwMDAgICAgICAwMDAwMDAwICAwMDAgICAwMDBcbiMjI1xuXG57IGNvbG9ycywgc2xhc2gsIGFyZ3MsIGtsb2csIF8gfSA9IHJlcXVpcmUgJ2t4aydcblxucHJldHR5ID0gcmVxdWlyZSAnLi9wcmV0dHknXG5zaG91bGQgPSByZXF1aXJlICcuL3Nob3VsZCdcbnJ1bmNtZCA9IHJlcXVpcmUgJy4vcnVuY21kJ1xuY29uZmlnID0gcmVxdWlyZSAnLi9jb25maWcnXG5idWlsZCAgPSByZXF1aXJlICcuL2J1aWxkJ1xucGtnICAgID0gcmVxdWlyZSAnLi4vcGFja2FnZS5qc29uJ1xuXG53YXRjaGVyID0gbnVsbFxuXG5XYXRjaCA9ICh3bGssIG9wdCkgLT5cbiAgICBcbiAgICAjIGtsb2cgJ3dhdGNoJyB3bGssIG9wdFxuICAgIFxuICAgIHN0YXJ0ID0gKGNiKSAtPlxuXG4gICAgICAgIHBhc3MgPSAocCkgLT4gc2xhc2guZXh0KHApIGluIF8ua2V5cyhvcHQpXG5cbiAgICAgICAgZCA9IGFyZ3MuYXJndW1lbnRzWzBdID8gJy4nXG4gICAgICAgIHYgPSBcIiN7cGtnLnZlcnNpb259IOKXj1wiLmRpbS5ncmF5XG4gICAgICAgIGtsb2cgcHJldHR5LnRpbWUoKSwgXCLwn5GBICAgI3t2fSAje3ByZXR0eS5maWxlUGF0aCBzbGFzaC5yZXNvbHZlKGQpLCBjb2xvcnMud2hpdGV9XCIuZ3JheVxuICAgICAgICB3YXRjaGVyID0gcmVxdWlyZSgna3hrJykud2F0Y2gud2F0Y2ggZCwgcmVjdXJzaXZlOnRydWUsIGlnbm9yZTp3bGsuaWdub3JlXG4gICAgICAgIHdhdGNoZXIub24gJ2NoYW5nZScgKGluZm8pIC0+IFxuICAgICAgICAgICAgaWYgcGFzcyBpbmZvLnBhdGggdGhlbiBjYiBzbGFzaC5wYXRoIGluZm8ucGF0aFxuXG4gICAgc3RhcnQgKHNvdXJjZUZpbGUpIC0+XG5cbiAgICAgICAgc291cmNlRmlsZSA9IHNsYXNoLnJlc29sdmUgc291cmNlRmlsZVxuICAgICAgICBvID0gY29uZmlnLm9iaiBzb3VyY2VGaWxlLCBvcHRcblxuICAgICAgICB0ZXN0ID0gKHNvdXJjZSkgLT5cbiAgICAgICAgICAgIGlmIHNob3VsZCAndGVzdCcgbywgc291cmNlXG4gICAgICAgICAgICAgICAgcnVuY21kICd0ZXN0JyBzb3VyY2UsIGNvbmZpZy5wYXRoICd0ZXN0JyBzbGFzaC5yZXNvbHZlKHNvdXJjZSksIG9wdFxuXG4gICAgICAgIGlmIG5vdCBzaG91bGQgJ2lnbm9yZScgbywgc291cmNlRmlsZVxuICAgICAgICAgICAgYnVpbGQgc291cmNlRmlsZSwgb3B0LCB0ZXN0XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIHRlc3Qgc291cmNlRmlsZVxuXG5tb2R1bGUuZXhwb3J0cyA9IFdhdGNoXG4iXX0=
//# sourceURL=../coffee/watch.coffee